



CREATE TABLE DATA_TABLE (
    Season VARCHAR2(200),
    "Date" VARCHAR2(200),
    Event VARCHAR2(200),
    Circuit VARCHAR2(200),
    Driver VARCHAR2(200),
    Constructor VARCHAR2(200),
    Laps NUMBER,
    Time VARCHAR2(200),
    Points NUMBER,
    Start_driver_place NUMBER,
    Pole_position VARCHAR2(200),
    Winner VARCHAR2(200),
    Driver_Wins NUMBER,
    Constructor_Wins NUMBER
);


INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','03-17-2019','Australian Grand Prix','Albert Park Grand Prix Circuit','Valtteri Bottas','Mercedes','58','0.0593402777777778','26','2','Lewis Hamilton','Valtteri Bottas','7','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','03-17-2019','Australian Grand Prix','Albert Park Grand Prix Circuit','Lewis Hamilton','Mercedes','58','20.886','18','1','Lewis Hamilton','Valtteri Bottas','84','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','03-17-2019','Australian Grand Prix','Albert Park Grand Prix Circuit','Max Verstappen','Red Bull','58','22.52','15','3','Lewis Hamilton','Valtteri Bottas','8','62');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','03-31-2019','Bahrain Grand Prix','Bahrain International Circuit','Lewis Hamilton','Mercedes','57','0.0655208333333333','25','3','Charles Leclerc','Lewis Hamilton','84','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','03-31-2019','Bahrain Grand Prix','Bahrain International Circuit','Valtteri Bottas','Mercedes','57','2.98','18','2','Charles Leclerc','Lewis Hamilton','7','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','03-31-2019','Bahrain Grand Prix','Bahrain International Circuit','Charles Leclerc','Ferrari','57','6.131','16','1','Charles Leclerc','Lewis Hamilton','2','239');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','04-14-2019','Chinese Grand Prix','Shanghai International Circuit','Lewis Hamilton','Mercedes','56','0.0639583333333333','26','1','Valtteri Bottas','Lewis Hamilton','84','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','04-14-2019','Chinese Grand Prix','Shanghai International Circuit','Valtteri Bottas','Mercedes','56','6.552','18','2','Valtteri Bottas','Lewis Hamilton','7','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','04-14-2019','Chinese Grand Prix','Shanghai International Circuit','Sebastian Vettel','Ferrari','56','13.774','15','4','Valtteri Bottas','Lewis Hamilton','53','239');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','04-28-2019','Azerbaijan Grand Prix','Baku City Circuit','Valtteri Bottas','Mercedes','51','0.0637962962962963','26','2','Valtteri Bottas','Valtteri Bottas','7','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','04-28-2019','Azerbaijan Grand Prix','Baku City Circuit','Lewis Hamilton','Mercedes','51','1.524','18','1','Valtteri Bottas','Valtteri Bottas','84','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2019 SEASON','04-28-2019','Azerbaijan Grand Prix','Baku City Circuit','Sebastian Vettel','Ferrari','51','11.739','15','4','Valtteri Bottas','Valtteri Bottas','53','239');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','03-25-2018','Australian Grand Prix','Albert Park Grand Prix Circuit','Sebastian Vettel','Ferrari','58','0.062190775462963','25','3','Lewis Hamilton','Sebastian Vettel','53','239');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','03-25-2018','Australian Grand Prix','Albert Park Grand Prix Circuit','Lewis Hamilton','Renault','58','5.036','18','1','Lewis Hamilton','Sebastian Vettel','84','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','03-25-2018','Australian Grand Prix','Albert Park Grand Prix Circuit','Kimi Räikkönen','Ferrari','58','6.309','15','2','Lewis Hamilton','Sebastian Vettel','21','239');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','04-08-2018','Bahrain Grand Prix','Bahrain International Circuit','Sebastian Vettel','Ferrari','57','0.0639113425925926','25','1','Sebastian Vettel','Sebastian Vettel','53','239');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','04-08-2018','Bahrain Grand Prix','Bahrain International Circuit','Valtteri Bottas','Mercedes','57','0.699','18','3','Sebastian Vettel','Sebastian Vettel','7','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','04-08-2018','Bahrain Grand Prix','Bahrain International Circuit','Lewis Hamilton','Renault','57','6.512','15','4','Sebastian Vettel','Sebastian Vettel','84','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','04-15-2018','Chinese Grand Prix','Shanghai International Circuit','Daniel Ricciardo','Red Bull','56','0.066393287037037','25','2','Sebastian Vettel','Daniel Ricciardo','7','62');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','04-15-2018','Chinese Grand Prix','Shanghai International Circuit','Valtteri Bottas','Mercedes','56','8.894','18','1','Sebastian Vettel','Daniel Ricciardo','7','102');
INSERT INTO DATA_TABLE(Season,"Date",Event,Circuit,Driver,Constructor,Laps,Time,Points,Start_driver_place,Pole_position,Winner,Driver_Wins,Constructor_Wins) VALUES('2018 SEASON','04-15-2018','Chinese Grand Prix','Shanghai International Circuit','Kimi Räikkönen','Ferrari','56','9.637','15','3','Sebastian Vettel','Daniel Ricciardo','21','239');


merge into driver
    using (
        select distinct
        dt.driver d_name,
        dt.driver_wins d_win
        from data_table dt
    ) tmp
    on (
    tmp.d_name = driver.name and
    tmp.d_win = driver.wins
    )
when not matched then 
    insert (
    driver.name,
    driver.wins
    ) values (
    tmp.d_name,
    tmp.d_win
    );
    
-- delete from driver;
    
--select * from driver;


merge into constructor 
    using (
        select distinct
        dt.constructor con_name,
        dt.constructor_wins con_win
        from data_table dt
    ) tmp
    on (
    tmp.con_name = constructor.name and
    tmp.con_win = constructor.wins
    )
when not matched then
    insert (
    constructor.name,
    constructor.wins
    ) values (
    tmp.con_name, 
    tmp.con_win
    );
    
merge into season
    using (
        select distinct
        dt.season name
        from data_table dt
    ) tmp
    on (
    season.name = tmp.name
    )
when not matched then
    insert (
    season.name
    ) values (
    tmp.name
    );

merge into circuit 
    using (
        select distinct
        dt.circuit c_name
        from data_table dt
    ) tmp
    on (
    circuit.name = tmp.c_name
    )
when not matched then
    insert (
    circuit.name
    ) values (
    tmp.c_name
    );


merge into event
    using (
        select distinct
        dt."Date" e_date,
        dt.event e_name
        from data_table dt
    ) tmp 
    on (
    event.name = tmp.e_name and
    event.e_date = to_date(tmp.e_date,'mm/dd/yyyy')
    )
when not matched then
    insert (
    event.name,
    event.e_date
    ) values (
    tmp.e_name,
    to_date(tmp.e_date,'mm/dd/yyyy')
    );
    
    

merge into event_statistic
    using (
        select distinct
        e.id e_id,
        d.id d_id,
        pole.id p_id,
        dt.laps laps,
        s.id s_id
        from data_table dt
        left join event e
        on e.name = dt.event and to_date(dt."Date",'mm/dd/yyyy') = e.e_date
        left join driver d
        on d.name = dt.winner
        left join driver pole
        on pole.name = dt.pole_position
        left join season s
        on s.name = dt.season
    ) tmp
    on (
    event_statistic.event_id = tmp.e_id and
    event_statistic.season_id = tmp.s_id and
    event_statistic.winner_id = tmp.d_id and
    event_statistic.pole_position_id = tmp.p_id and
    event_statistic.laps = tmp.laps
    ) 
when not matched then
    insert (
    event_statistic.event_id,
    event_statistic.season_id,
    event_statistic.winner_id,
    event_statistic.pole_position_id,
    event_statistic.laps
    ) values (
    tmp.e_id,
    tmp.s_id,
    tmp.d_id,
    tmp.p_id,
    tmp.laps
    );

delete from event_statistic

merge into event_driver 
    using (
        select distinct
        dt.start_driver_place s_pos,
        d.id d_id,
        dt.points pts,
        dt.time d_time,
        c.id c_id,
        e.id e_id
        from data_table dt
        left join driver d
        on d.name = dt.driver
        left join constructor c
        on c.name = dt.constructor
        left join event e
        on e.name = dt.event and to_date(dt."Date", 'mm/dd/yyyy') = e.e_date
    ) tmp
    on (
    event_driver.event_id = tmp.e_id and
    event_driver.driver_id = tmp.d_id and
    event_driver.constructor_id = tmp.c_id and
    event_driver.start_position = tmp.s_pos and
    event_driver.points = tmp.pts and
    event_driver.time = tmp.d_time 
    )
when not matched then
    insert (
    event_driver.event_id,
    event_driver.driver_id,
    event_driver.constructor_id,
    event_driver.start_position,
    event_driver.points,
    event_driver.time
    ) values (
    tmp.e_id,
    tmp.d_id,
    tmp.c_id,
    tmp.s_pos,
    tmp.pts,
    tmp.d_time
    );
    
merge into season_event 
    using (
        select distinct
        s.id s_id,
        e.id e_id,
        circ.id c_id
        from data_table dt
        left join event e
        on e.name = dt.event and to_date(dt."Date", 'mm/dd/yyyy') = e.e_date
        left join season s
        on s.name = dt.season
        left join circuit circ
        on circ.name = dt.circuit
    ) tmp
    on (
    season_event.season_id = tmp.s_id and
    season_event.event_id = tmp.e_id and
    season_event.circuit_id = tmp.c_id 
    )
when not matched then
    insert (
    season_event.season_id,
    season_event.event_id,
    season_event.circuit_id
    ) values (
    tmp.s_id,
    tmp.e_id,
    tmp.c_id
    );



create view test_view as 
select distinct
ses.name Season,
to_char(e.e_date, 'mm-dd-yyyy') "Date",
e.name Event,
circ.name Circuit,
d.name Driver,
c.name Constructor,
es.laps Laps,
ed.time Time,
ed.points Points,
ed.start_position Start_driver_place,
pole.name Pole_position,
win.name Winner,
d.wins Driver_Wins,
c.wins Constructor_Wins
from event_driver ed
left join driver d
on d.id = ed.driver_id
left join constructor c
on c.id = ed.constructor_id
left join event e
on e.id = ed.event_id
left join season_event se
on se.event_id = e.id
left join circuit circ
on circ.id = se.circuit_id
left join season ses
on ses.id = se.season_id
left join event_statistic es
on es.event_id = e.id
left join driver pole
on pole.id = es.pole_position_id
left join driver win
on win.id = es.winner_id;

select * from data_table minus select * from test_view;